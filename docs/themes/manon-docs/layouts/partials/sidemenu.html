{{/* On section pages (_index.md) we can expect content and we want to
differentiate between rendering the table of content for those or when
we need to render by the pages */}}
<nav>
    {{ if gt (len .Content) 0 }}
    <ul>
        {{- $headers := findRE "<h[1-4].*?>(.|\n])+?</h[1-4]>" .Content -}}
            {{ range $headers }}

            {{ $lastLevel := $.Scratch.Get "lastLevel" }}
            {{ $header := . }}
            {{ $base := ($.Page.File.LogicalName) }}
            {{ $anchorID := ($header | plainify | htmlUnescape | anchorize) }}

            {{ $headerID := index (findRE "(id=\"([^\"]*?)\")" $header) 0}}
            {{ $id := replace (replace $headerID "id=\"" "") "\"" "" }}

            {{ $text := $header | plainify | htmlUnescape }}

            {{ range findRE "[1-4]" . 1 }}
            {{ $nextLevel := (int .) }}

            {{ if gt $nextLevel $lastLevel }}
            <ul>
                {{ else if lt $nextLevel $lastLevel }}
            </ul>
            {{ end }}

            <li><a href="{{ if $id }}#{{ $id }}{{ else }}#{{ $anchorID }}{{ end }}">{{ $text }}</a></li>
            {{ $.Scratch.Set "lastLevel" $nextLevel}}

            {{ end }}

            {{ end }}

    </ul>
    {{ else }}
    <ul>
        {{ $parent := .Page }}

        {{ $pages := (where .Site.Pages "Section" .Section).ByWeight }}
        {{ $pages = (where $pages ".Parent" "!=" nil) }}
        {{ $pages = (where $pages "Parent.File.UniqueID" "==" $parent.File.UniqueID) }}

        {{ range $pages }}
        <li><a href="{{ .RelPermalink }}">{{ .Title }}</a></li>
        {{ end }}
    </ul>
    {{ end }}
</nav>
